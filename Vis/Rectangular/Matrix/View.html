<style type="text/css">
	#VIS_ID_CONTAINER rect.bordered {
		stroke: #E6E6E6;
		stroke-width: 2px;
	}

	#VIS_ID_CONTAINER text.mono {
		font-size: 9pt;
		font-family: Consolas, courier;
		fill: #aaa;
	}

	#VIS_ID_CONTAINER text.axis-workweek {
		fill: #000;
	}

	#VIS_ID_CONTAINER text.axis-worktime {
		fill: #000;
	}
</style>

<div style="width: 100%;" id="VIS_ID"></div>

<div id="VIS_ID_CONTAINER">
	<div id="VIS_ID_HOLDER">
		<div id="VIS_ID"></div>
	</div>
</div>

<script type="text/javascript" src="d3.v3.min.js"></script>

<script type="text/javascript">
	(function ExecuteVIS_ID() {
		var VIS_EMBEDDED_DATA;

		var width = 720, height = 500;

		var util = window.ReportScripting, vis,
			isThumbnails = (document.URL === 'about:blank');

		try {
			if (typeof window.jq$ == "undefined") {
				window.jq$ = jQuery.noConflict(true);
			}

			if (jq$("#VIS_ID").size() < 1) {
				util.unregisterResize("VIS_ID");
				return;
			}

			if (!util.validate("VIS_ID", VIS_FORMJSASTATUS, (typeof VIS_CONTEXT) != "undefined" ? VIS_CONTEXT : {}, { d3: true, svg: true })) {
				return;
			}

			var i, t, rotate = true, rotateBox, hc = 0, buckets = 9, left = 14, top;
			var colors = ["#ffffd9", "#edf8b1", "#c7e9b4", "#7fcdbb", "#41b6c4", "#1d91c0", "#225ea8", "#253494", "#081d58"];

			vis = new util("VIS_ID", VIS_FORMJSASTATUS, VIS_COLUMNS, VIS_ROWS, VIS_CONTEXT);

			vis.collectMonthlyData();
			vis.signWithData();

			width = vis.getWidth();
			height = vis.getHeight();

			hc = d3.max(vis.items, function (d) { return vis.unitValue(d, 2).length; });

			function processData() {
				var colorScale = d3.scale.quantile()
					.domain([0, buckets - 1, vis.unitValue(vis.max, 2)])
					.range(colors);

				var svg = d3.select("#VIS_ID").append("svg");

				for (i = 0; i < vis.items.length; i++) {
					t = util.labelBBox(svg, vis.unitValue(vis.items[i], 0)).width;
					left = t > left ? t : left;
				}

				rotateBox = rotate ? util.labelBBox(svg, "XXX XXXX") : util.labelBBox(svg, "XX/XX");
				top = rotate ? rotateBox.width : rotateBox.height;

				var margin = { top: top + 6, right: 0, bottom: 30, left: left + 16 },
					widthWithMargins = width - margin.left - margin.right,
					gridSize = Math.floor(widthWithMargins / hc),

				height = (vis.items.length + 1) * gridSize + top + rotateBox.height;

				svg.attr("width", width).attr("height", height);

				jq$('#VIS_ID_INSUFFICIENT_WIDTH_MESSAGE').remove();

				function showInsufficientWidth(width, height) {
					var insufficientWidthMessage = '<div id="VIS_ID_INSUFFICIENT_WIDTH_MESSAGE" style="width: ' + (width - 20) + 'px; height: ' + (height - 20) + 'px; text-align: center; font-size: 16px; padding: 10px;"><span style="position: relative; top: 45%;">Insufficient Width</span></div>';
					jq$('#VIS_ID').html(insufficientWidthMessage);
				}

				function checkInsufficientWidth(width, count) {
					return (width < 320 || width < count * 32);
				}

				var isInsufficientWidth = checkInsufficientWidth(width, hc),
					isImageRender = VIS_CONTEXT.toImage || VIS_CONTEXT.toStatic || isThumbnails;

				if (isInsufficientWidth && !isImageRender) {
					showInsufficientWidth(width, height);
					util.registerResize("VIS_ID", ExecuteVIS_ID, function () {
						jq$("#VIS_ID").empty();
					});
					return;
				}

				var g = svg.append("g")
					.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

				g.selectAll(".dayLabel")
					.data(vis.items)
					.enter().append("text")
						.text(function(d) { return vis.unitValue(d, 0); })
						.attr("x", 0)
						.attr("y", function(d, i2) { return i2 * gridSize; })
						.style("text-anchor", "end")
						.attr("transform", "translate(-6," + gridSize / 1.5 + ")")
						.attr("class", "dayLabel mono axis axis-workweek");

				g.selectAll(".timeLabel")
					.data(vis.unitValue(vis.items[0], 2))
					.enter().append("text")
						.text(function(d) { return util.renderDate(util.getDateByOffset(vis.unitValue(vis.min, 1), d[0])); })
						.attr("x", rotate ? 0 : function(d, i2) { return i2 * gridSize; })
						.attr("y", rotate ? function(d, i2) { return i2 * gridSize; } : 0)
						.style("text-anchor", rotate ? "end" : "middle")
						.attr("transform", rotate ? "rotate(-90) translate(" + (rotateBox.width + 6) + ", " + ((gridSize + rotateBox.height - 4) / 2) + ")" : "translate(" + gridSize / 2 + ", -6)")
						.attr("class", "timeLabel mono axis axis-worktime");

				for (i = 0; i < vis.items.length; i++) {
					g.append("g").selectAll(".hour")
						.data(vis.unitValue(vis.items[i], 2))
						.enter().append("rect")
						.attr("x", function(d, i2) { return (i2 * gridSize); })
						.attr("y", function(d) { return (i * gridSize); })
						.attr("rx", 4)
						.attr("ry", 4)
						.attr("class", "hour bordered")
						.attr("width", gridSize)
						.attr("height", gridSize)
						.style("fill", colors[0])
						.on("mouseover", function (d) {
							var data = {};
							jq$.each(d.data, function (key, value) {
								var fieldFormatter = VIS_COLUMNS.find(function (d) { return d.name == key; }).formatter;
								data[key] = fieldFormatter ? fieldFormatter(value, d.data, vis, key) : value + '';
							});
							util.showTooltip(data);
						})
						.on("mouseout", function() { util.hideTooltip(); });
				}

				g.selectAll(".hour").transition().duration(1000)
					.style("fill", function(d) { return colorScale(d[1]); });

				var quantiles, legend = g.selectAll(".legend")
					.data(quantiles = [0].concat(colorScale.quantiles()), function(d) { return d; })
					.enter().append("g")
					.attr("class", "legend");

				var legendItemWidth = (gridSize * vis.unitValue(vis.items[0], 2).length) / quantiles.length,
					legendItemHeight = gridSize / 3;

				legend.append("rect")
					.attr("x", function(d, i2) { return legendItemWidth * i2; })
					.attr("y", (vis.items.length + 1/3) * gridSize)
					.attr("width", legendItemWidth)
					.attr("height", legendItemHeight)
					.style("fill", function(d, i2) { return colors[i2]; });

				legend.append("text")
					.attr("class", "mono")
					.text(function(d) { return "≥ " + Math.round(d); })
					.attr("x", function(d, i2) { return legendItemWidth * i2; })
					.attr("y", ((vis.items.length + 2/3) * gridSize) + rotateBox.height);
			}

			util.registerResize("VIS_ID", ExecuteVIS_ID, function () {
				jq$("#VIS_ID").empty();
			});

			processData();
		}
		catch (e) {
			util.logger.error(e);
			if (VIS_CONTEXT.docUrl) {
				var docElement = jq$('<object>').width(width).height(height).attr('data', VIS_CONTEXT.docUrl);
				jq$('#VIS_ID').empty().html(docElement);
			}
		}
	})();
</script>
